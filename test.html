<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <title>In-App Notice + Toggle</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
    </head>
    <body
        style="margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f4f6f8;">

        <!-- BANNER (nằm trên cùng) -->
        <div id="inapp-notice" style="
    position:sticky;
    top:0;
    width:100%;
    display:none;
    background:#fffaf2;
    border-bottom:1px solid #f1d9a6;
    padding:10px 14px;
    font-size:13px;
    color:#4b3c13;
    z-index:100000;
">
            <div style="
        max-width:1000px;
        margin:0 auto;
        display:flex;
        align-items:center;
        gap:12px;
        flex-wrap:wrap;
    ">
                <!-- Icon -->
                <div style="
            width:22px;
            height:22px;
            border-radius:50%;
            background:#3b82f6;
            color:#fff;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:14px;
            font-weight:700;
            flex-shrink:0;
        ">
                    i
                </div>

                <!-- Nội dung -->
                <div style="
            flex:1;
            line-height:1.4;
            min-width:220px;
        ">
                    <b>Trình duyệt trong ứng dụng có thể bị hạn chế.</b>
                    <span style="font-weight:500;">
                        Để đăng ký, đăng nhập và tải game ổn định, vui lòng sao
                        chép link và mở bằng
                        Chrome (Android/PC) hoặc Safari (iPhone).
                    </span>
                </div>

                <!-- Nút Copy -->
                <button id="copyLinkBtn" style="
            padding:6px 14px;
            border-radius:999px;
            border:1px solid #e6b65c;
            background:#ffd27a;
            color:#4b2c00;
            font-weight:700;
            font-size:13px;
            cursor:pointer;
            white-space:nowrap;
            box-shadow:0 1px 3px rgba(0,0,0,0.08);
        ">
                    Sao chép link
                </button>
            </div>
        </div>

        <!-- Nội dung -->
        <div style="padding:20px;max-width:900px;margin:0 auto;">
            <h2 style="margin-top:8px">Trang demo</h2>
            <p>Mở bình thường → banner ẩn.</p>
            <p>Mở <code>?debugInapp=1</code> hoặc <code>#debugInapp=1</code> →
                giả lập in-app, banner hiện.</p>

            <p>
                <button id="forceShowBtn"
                    style="padding:8px 12px;border-radius:6px;border:1px solid #888;background:#fff;cursor:pointer;">Bật
                    banner (test)</button>
                <button id="resetDismiss"
                    style="padding:8px 12px;border-radius:6px;border:1px solid #888;background:#fff;cursor:pointer;margin-left:8px;">Reset
                    trạng thái đã đóng</button>
            </p>

            <pre id="debugArea"
                style="background:#fff;padding:10px;border-radius:6px;border:1px solid #e1e1e1;color:#222;"></pre>
        </div>

        <script>
    (function () {
      const LS_KEY = 'inappNoticeDismissed_v1';
      const banner = document.getElementById('inapp-notice');
      const copyBtn = document.getElementById('copyLinkBtn');
      const openBtn = document.getElementById('openBrowserBtn');
      const closeBtn = document.getElementById('closeNoticeBtn');
      const forceBtn = document.getElementById('forceShowBtn');
      const resetBtn = document.getElementById('resetDismiss');
      const debugArea = document.getElementById('debugArea');

      function detectInAppByUA() {
        const ua = (navigator.userAgent || '').toLowerCase();
        return (
          ua.includes('fbav') ||
          ua.includes('fban') ||
          ua.includes('fb_iab') ||
          ua.includes('facebook') ||
          ua.includes('instagram') ||
          ua.includes('messenger') ||
          ua.includes('zalo') ||
          ua.includes('telegram') ||
          ua.includes('whatsapp') ||
          ua.includes(' line/')
        );
      }

      function hasDebugFlag() {
        try {
          const params = new URLSearchParams(window.location.search);
          if (params.get('debugInapp') === '1') return true;
        } catch (e) { /* ignore */ }
        if (window.location.hash && window.location.hash.indexOf('debugInapp=1') !== -1) return true;
        return false;
      }

      function isDismissed() {
        try { return localStorage.getItem(LS_KEY) === '1'; } catch(e){ return false; }
      }

      function setDismissed(val) {
        try { localStorage.setItem(LS_KEY, val ? '1' : '0'); } catch(e){}
      }

      function showBanner() {
        banner.style.display = 'block';
        // scroll to top to ensure visible on smaller screens
        if (window.scrollY > 100) window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      function hideBanner() {
        banner.style.display = 'none';
      }

      function updateDebugInfo(extra) {
        const ua = navigator.userAgent || '(no UA)';
        const info = [
          'User-Agent: ' + (ua.length > 160 ? ua.slice(0,160) + '...' : ua),
          'detectInAppByUA: ' + detectInAppByUA(),
          'debugFlag: ' + hasDebugFlag(),
          'dismissed(localStorage): ' + isDismissed(),
          extra || ''
        ];
        if (debugArea) debugArea.textContent = info.join('\n');
        console.log('[inapp-debug]', info.join(' | '));
      }

      // DOM ready
      document.addEventListener('DOMContentLoaded', function () {
        const shouldShow = hasDebugFlag() || detectInAppByUA();
        updateDebugInfo();

        // chỉ show nếu user chưa dismiss
        if (shouldShow && !isDismissed()) {
          showBanner();
        }

        // handlers
        copyBtn.addEventListener('click', function () {
          const url = window.location.href.split('#')[0].split('?')[0];
          const toCopy = url + (window.location.search ? window.location.search : '') + (window.location.hash ? window.location.hash : '');
          navigator.clipboard?.writeText(toCopy).then(function () {
            copyBtn.textContent = 'Đã copy ✓';
            setTimeout(()=> copyBtn.textContent = 'Sao chép link', 1600);
          }).catch(function () {
            // fallback
            const ta = document.createElement('textarea');
            ta.value = toCopy;
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); copyBtn.textContent = 'Đã copy ✓'; } catch(e){ alert('Không copy được, hãy sao chép tay: ' + toCopy); }
            document.body.removeChild(ta);
            setTimeout(()=> copyBtn.textContent = 'Sao chép link', 1600);
          });
        });

        openBtn.addEventListener('click', function () {
          // cố gắng mở bằng chrome (một số thiết bị/OS sẽ không hỗ trợ scheme)
          const url = window.location.href.split('#')[0].split('?')[0] + (window.location.search ? window.location.search : '') + (window.location.hash ? window.location.hash : '');
          // thử scheme Chrome trên Android (fallback: open new tab)
          const ua = (navigator.userAgent || '').toLowerCase();
          if (ua.includes('android')) {
            // intent fallback — có thiết bị sẽ ignore nếu không có chrome
            try {
              window.location.href = 'intent://' + url.replace(/^https?:\/\//, '') + '#Intent;package=com.android.chrome;scheme=https;end';
            } catch (e) {
              window.open(url, '_blank');
            }
            // nếu intent không thành công, user có thể dùng nút copy
          } else {
            // iOS & desktop: mở tab mới (Safari trên iOS thường yêu cầu người dùng chọn 'Open in Safari')
            window.open(url, '_blank', 'noopener,noreferrer');
          }
        });

        closeBtn.addEventListener('click', function () {
          hideBanner();
          setDismissed(true);
          updateDebugInfo('Closed by user');
        });

        forceBtn.addEventListener('click', function () {
          setDismissed(false);
          showBanner();
          updateDebugInfo('Forced show by button');
        });

        resetBtn.addEventListener('click', function () {
          setDismissed(false);
          updateDebugInfo('Reset dismissed flag');
        });

        // expose for console tests
        window.__inappNotice = {
          show: function(){ setDismissed(false); showBanner(); updateDebugInfo('manual show'); },
          hide: function(){ hideBanner(); setDismissed(true); updateDebugInfo('manual hide'); },
          reset: function(){ setDismissed(false); updateDebugInfo('manual reset'); },
          status: function(){ updateDebugInfo('status requested'); }
        };

      }); // DOMContentLoaded
    })();
  </script>
    </body>
</html>
